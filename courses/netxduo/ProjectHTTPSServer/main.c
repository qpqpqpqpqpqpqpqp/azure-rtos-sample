#include "tx_api.h"
#include "nx_api.h"
#include "nx_secure_tls_api.h"
#include "nx_secure_x509.h"

#define DEMO_STACK_SIZE 4096

/* Define the IP address for this device. */
#define DEVICE_IP_ADDRESS IP_ADDRESS(192, 168, 1, 2)

/***** Substitute your ethernet driver entry function here *********/
extern VOID _nx_linux_network_driver(NX_IP_DRIVER *);

/* Define the ThreadX and NetX object control blocks...  */

NX_PACKET_POOL pool_0;
NX_IP ip_0;
NX_TCP_SOCKET tcp_socket;
NX_SECURE_TLS_SESSION tls_session;
NX_SECURE_X509_CERT certificate;

/* Define the IP thread's stack area.  */
ULONG ip_thread_stack[3 * 1024 / sizeof(ULONG)];

/* Define packet pool for the demonstration.  */
#define NX_PACKET_POOL_SIZE ((1536 + sizeof(NX_PACKET)) * 32)

ULONG packet_pool_area[NX_PACKET_POOL_SIZE / sizeof(ULONG) + 64 / sizeof(ULONG)];

/* Define the ARP cache area.  */
ULONG arp_space_area[512 / sizeof(ULONG)];

/* Define the TLS Server thread.  */
ULONG tls_server_thread_stack[6 * 1024 / sizeof(ULONG)];
TX_THREAD tls_server_thread;
void server_thread_entry(ULONG thread_input);

/* Define the TLS packet reassembly buffer. */
UCHAR tls_packet_buffer[18000];

/* Define the metadata area for TLS cryptography. The actual size needed can be
   Ascertained by calling nx_secure_tls_metadata_size_calculate.
*/
UCHAR tls_crypto_metadata[18000];

/* Pointer to the TLS ciphersuite table that is included in the platform-specific
   cryptography subdirectory. The table maps the cryptographic routines for the
   platform to function pointers usable by the TLS library.
*/
extern const NX_SECURE_TLS_CRYPTO nx_crypto_tls_ciphers_ecc;
extern const USHORT nx_crypto_ecc_supported_groups[];
extern const NX_CRYPTO_METHOD *nx_crypto_ecc_curves[];
extern const UINT nx_crypto_ecc_supported_groups_size;

/* Binary data for the TLS Server X.509 certificate, ASN.1 DER-encoded. Note that the
   certificate data and private key data is represented by an ellipsis for the sake
   of brevity.
*/
/* DER-encoded binary certificate. */
const UCHAR certificate_data[] = {
    0x30, 0x82, 0x03, 0x11, 0x30, 0x82, 0x01, 0xF9, 0x02, 0x14, 0x25, 0x1F,
    0xB0, 0xB5, 0x2A, 0xEB, 0x33, 0x30, 0x86, 0xF7, 0x64, 0x1B, 0xB2, 0x59,
    0xCD, 0x0E, 0x09, 0x4C, 0xD4, 0x27, 0x30, 0x0D, 0x06, 0x09, 0x2A, 0x86,
    0x48, 0x86, 0xF7, 0x0D, 0x01, 0x01, 0x0B, 0x05, 0x00, 0x30, 0x45, 0x31,
    0x0B, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x41, 0x55,
    0x31, 0x13, 0x30, 0x11, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0C, 0x0A, 0x53,
    0x6F, 0x6D, 0x65, 0x2D, 0x53, 0x74, 0x61, 0x74, 0x65, 0x31, 0x21, 0x30,
    0x1F, 0x06, 0x03, 0x55, 0x04, 0x0A, 0x0C, 0x18, 0x49, 0x6E, 0x74, 0x65,
    0x72, 0x6E, 0x65, 0x74, 0x20, 0x57, 0x69, 0x64, 0x67, 0x69, 0x74, 0x73,
    0x20, 0x50, 0x74, 0x79, 0x20, 0x4C, 0x74, 0x64, 0x30, 0x1E, 0x17, 0x0D,
    0x32, 0x33, 0x30, 0x38, 0x32, 0x38, 0x30, 0x32, 0x30, 0x39, 0x31, 0x30,
    0x5A, 0x17, 0x0D, 0x33, 0x33, 0x30, 0x38, 0x32, 0x35, 0x30, 0x32, 0x30,
    0x39, 0x31, 0x30, 0x5A, 0x30, 0x45, 0x31, 0x0B, 0x30, 0x09, 0x06, 0x03,
    0x55, 0x04, 0x06, 0x13, 0x02, 0x41, 0x55, 0x31, 0x13, 0x30, 0x11, 0x06,
    0x03, 0x55, 0x04, 0x08, 0x0C, 0x0A, 0x53, 0x6F, 0x6D, 0x65, 0x2D, 0x53,
    0x74, 0x61, 0x74, 0x65, 0x31, 0x21, 0x30, 0x1F, 0x06, 0x03, 0x55, 0x04,
    0x0A, 0x0C, 0x18, 0x49, 0x6E, 0x74, 0x65, 0x72, 0x6E, 0x65, 0x74, 0x20,
    0x57, 0x69, 0x64, 0x67, 0x69, 0x74, 0x73, 0x20, 0x50, 0x74, 0x79, 0x20,
    0x4C, 0x74, 0x64, 0x30, 0x82, 0x01, 0x22, 0x30, 0x0D, 0x06, 0x09, 0x2A,
    0x86, 0x48, 0x86, 0xF7, 0x0D, 0x01, 0x01, 0x01, 0x05, 0x00, 0x03, 0x82,
    0x01, 0x0F, 0x00, 0x30, 0x82, 0x01, 0x0A, 0x02, 0x82, 0x01, 0x01, 0x00,
    0x9F, 0xD3, 0x50, 0xCB, 0x25, 0x74, 0xC9, 0xCB, 0xD2, 0x68, 0x07, 0x30,
    0xBF, 0x2D, 0x93, 0x08, 0x86, 0x3D, 0x82, 0x56, 0xC4, 0x28, 0x8F, 0xFD,
    0x61, 0x75, 0x29, 0xB3, 0x79, 0x62, 0xC1, 0xE9, 0xC3, 0x8E, 0xB6, 0xF6,
    0x20, 0x47, 0x34, 0x44, 0x3D, 0x41, 0x42, 0xBC, 0xC1, 0xC4, 0xAB, 0xFC,
    0x20, 0x72, 0x32, 0x67, 0x4E, 0xBC, 0x0C, 0x47, 0xD3, 0x60, 0xC1, 0x49,
    0x5A, 0x9B, 0x8D, 0x98, 0x23, 0x3C, 0x1E, 0xFD, 0x62, 0x8C, 0xB2, 0xD9,
    0xD3, 0x85, 0x22, 0xDE, 0x5B, 0xBB, 0xE4, 0x13, 0xA0, 0xD1, 0x04, 0x9F,
    0xC7, 0x3D, 0xA8, 0x5B, 0x5D, 0x1C, 0x87, 0xCC, 0xE4, 0x81, 0xF3, 0x4D,
    0x9F, 0xDD, 0x24, 0x95, 0xAE, 0xC1, 0xC0, 0xEE, 0x02, 0xAE, 0xD6, 0xB5,
    0xE2, 0xF7, 0xBD, 0x31, 0x53, 0xD9, 0xF4, 0xD4, 0x15, 0xDD, 0x2E, 0x7A,
    0x8A, 0x46, 0xEF, 0xA2, 0xE2, 0x15, 0x95, 0xAF, 0x8C, 0x10, 0x28, 0xCC,
    0x68, 0x6D, 0x57, 0x24, 0x86, 0xDC, 0xCB, 0x91, 0x33, 0xF0, 0x4A, 0xB2,
    0x77, 0xF2, 0x9C, 0x25, 0x88, 0x75, 0x7D, 0xEE, 0xEA, 0x09, 0x57, 0xFD,
    0x4E, 0x47, 0x87, 0x14, 0x24, 0x1E, 0xAE, 0x2B, 0x74, 0x0A, 0xE7, 0x42,
    0xB6, 0xEC, 0x1A, 0x35, 0x1E, 0xA2, 0x56, 0x9B, 0x83, 0xA4, 0x2E, 0xF7,
    0x02, 0x5F, 0x21, 0x68, 0x66, 0x18, 0x0E, 0x2F, 0x4D, 0xC7, 0x49, 0x87,
    0xBC, 0xC4, 0x66, 0x49, 0x96, 0x75, 0x5A, 0x75, 0xB9, 0x0A, 0xD9, 0x29,
    0x45, 0xCD, 0xD7, 0x2D, 0xD4, 0x92, 0xA7, 0xAB, 0x89, 0xE2, 0xE2, 0x41,
    0x42, 0x6C, 0xDC, 0xB6, 0x46, 0x0E, 0xCD, 0xC2, 0x7C, 0x9D, 0x03, 0x42,
    0xC1, 0x8D, 0xC8, 0xBA, 0x63, 0xF2, 0x75, 0xE2, 0xB7, 0xF3, 0xEA, 0x8C,
    0x60, 0x8D, 0x95, 0x69, 0x89, 0xCA, 0x01, 0xF9, 0x6F, 0xFB, 0xD0, 0x53,
    0x56, 0x5B, 0x66, 0xAF, 0x02, 0x03, 0x01, 0x00, 0x01, 0x30, 0x0D, 0x06,
    0x09, 0x2A, 0x86, 0x48, 0x86, 0xF7, 0x0D, 0x01, 0x01, 0x0B, 0x05, 0x00,
    0x03, 0x82, 0x01, 0x01, 0x00, 0x0C, 0x23, 0x8A, 0xD3, 0xCF, 0x6B, 0x05,
    0x74, 0xB2, 0xBB, 0x2F, 0xBA, 0xC6, 0xEF, 0x85, 0x31, 0x72, 0xA1, 0x61,
    0x96, 0xD2, 0x18, 0x15, 0x38, 0xBB, 0xB9, 0x19, 0x93, 0x52, 0x88, 0xC4,
    0x6D, 0x05, 0xE3, 0x3C, 0x16, 0x4C, 0x55, 0x0C, 0xFC, 0xD3, 0xDB, 0xD5,
    0xD9, 0xF9, 0x96, 0x45, 0xC5, 0xFE, 0x4E, 0xCB, 0x8C, 0xB1, 0x02, 0xB9,
    0x96, 0x14, 0xA3, 0x13, 0x0A, 0xDF, 0xCB, 0xD3, 0x2F, 0xF6, 0xEE, 0xA5,
    0x26, 0x71, 0xE2, 0x79, 0xEE, 0x52, 0x74, 0xFF, 0x2A, 0x99, 0x56, 0x28,
    0x7B, 0xFE, 0xAE, 0x73, 0xD6, 0xAC, 0x1E, 0xFA, 0xDF, 0x2E, 0x6A, 0xE4,
    0x6D, 0x40, 0xA2, 0x7B, 0xB2, 0x0B, 0x2C, 0xF9, 0x43, 0x2F, 0x51, 0x92,
    0x10, 0x42, 0x87, 0x01, 0xAD, 0x1E, 0x14, 0xA8, 0xC9, 0xED, 0x1D, 0xEF,
    0x4B, 0x10, 0xA3, 0x13, 0x12, 0x2E, 0x55, 0xD8, 0xC6, 0xE5, 0xD8, 0x11,
    0x67, 0xE8, 0x2F, 0xB5, 0xBF, 0x1C, 0xEA, 0xEF, 0x7C, 0x17, 0xFB, 0xD2,
    0xB3, 0x73, 0x80, 0x79, 0xB6, 0x55, 0x33, 0x9A, 0x18, 0x7B, 0x8E, 0x00,
    0xA7, 0x89, 0xBA, 0x23, 0x8A, 0x28, 0xF0, 0xA8, 0x59, 0x39, 0xD2, 0x99,
    0x10, 0x7A, 0x85, 0x87, 0x8A, 0x4E, 0x6E, 0xFB, 0x5E, 0xF8, 0x7B, 0xBA,
    0x13, 0x81, 0x54, 0x35, 0x02, 0x6F, 0x5F, 0xB0, 0xCC, 0x81, 0xEE, 0xC4,
    0xDB, 0x58, 0x66, 0x02, 0x50, 0x89, 0xE4, 0xBB, 0x9F, 0x9E, 0xA0, 0xE4,
    0x38, 0x3F, 0xD2, 0x5C, 0x1B, 0x00, 0xCE, 0x28, 0xB5, 0xCB, 0xB2, 0x08,
    0x9E, 0x4E, 0xB9, 0xBA, 0x15, 0x19, 0x94, 0xDA, 0xE1, 0x67, 0x05, 0xD0,
    0x7C, 0xD4, 0x8C, 0x78, 0x46, 0x7A, 0xA8, 0x5F, 0xFD, 0x49, 0x07, 0xE4,
    0x5F, 0x84, 0x74, 0xF9, 0x11, 0x13, 0xFD, 0x09, 0x60, 0x63, 0x2A, 0x8E,
    0xF0, 0xEE, 0xB3, 0x75, 0x4F, 0xFC, 0x34, 0x47, 0x12};
const UINT certificate_length = 789;

/* Binary data for the TLS Server Private Key, from private key
   file generated at the time of the X.509 certificate creation. ASN.1 DER-encoded. */
/* DER-encoded private key file (PKCS#1 RSA or ECC) */
const UCHAR private_key[] = {
    0x30, 0x82, 0x04, 0xA2, 0x02, 0x01, 0x00, 0x02, 0x82, 0x01, 0x01, 0x00,
    0x9F, 0xD3, 0x50, 0xCB, 0x25, 0x74, 0xC9, 0xCB, 0xD2, 0x68, 0x07, 0x30,
    0xBF, 0x2D, 0x93, 0x08, 0x86, 0x3D, 0x82, 0x56, 0xC4, 0x28, 0x8F, 0xFD,
    0x61, 0x75, 0x29, 0xB3, 0x79, 0x62, 0xC1, 0xE9, 0xC3, 0x8E, 0xB6, 0xF6,
    0x20, 0x47, 0x34, 0x44, 0x3D, 0x41, 0x42, 0xBC, 0xC1, 0xC4, 0xAB, 0xFC,
    0x20, 0x72, 0x32, 0x67, 0x4E, 0xBC, 0x0C, 0x47, 0xD3, 0x60, 0xC1, 0x49,
    0x5A, 0x9B, 0x8D, 0x98, 0x23, 0x3C, 0x1E, 0xFD, 0x62, 0x8C, 0xB2, 0xD9,
    0xD3, 0x85, 0x22, 0xDE, 0x5B, 0xBB, 0xE4, 0x13, 0xA0, 0xD1, 0x04, 0x9F,
    0xC7, 0x3D, 0xA8, 0x5B, 0x5D, 0x1C, 0x87, 0xCC, 0xE4, 0x81, 0xF3, 0x4D,
    0x9F, 0xDD, 0x24, 0x95, 0xAE, 0xC1, 0xC0, 0xEE, 0x02, 0xAE, 0xD6, 0xB5,
    0xE2, 0xF7, 0xBD, 0x31, 0x53, 0xD9, 0xF4, 0xD4, 0x15, 0xDD, 0x2E, 0x7A,
    0x8A, 0x46, 0xEF, 0xA2, 0xE2, 0x15, 0x95, 0xAF, 0x8C, 0x10, 0x28, 0xCC,
    0x68, 0x6D, 0x57, 0x24, 0x86, 0xDC, 0xCB, 0x91, 0x33, 0xF0, 0x4A, 0xB2,
    0x77, 0xF2, 0x9C, 0x25, 0x88, 0x75, 0x7D, 0xEE, 0xEA, 0x09, 0x57, 0xFD,
    0x4E, 0x47, 0x87, 0x14, 0x24, 0x1E, 0xAE, 0x2B, 0x74, 0x0A, 0xE7, 0x42,
    0xB6, 0xEC, 0x1A, 0x35, 0x1E, 0xA2, 0x56, 0x9B, 0x83, 0xA4, 0x2E, 0xF7,
    0x02, 0x5F, 0x21, 0x68, 0x66, 0x18, 0x0E, 0x2F, 0x4D, 0xC7, 0x49, 0x87,
    0xBC, 0xC4, 0x66, 0x49, 0x96, 0x75, 0x5A, 0x75, 0xB9, 0x0A, 0xD9, 0x29,
    0x45, 0xCD, 0xD7, 0x2D, 0xD4, 0x92, 0xA7, 0xAB, 0x89, 0xE2, 0xE2, 0x41,
    0x42, 0x6C, 0xDC, 0xB6, 0x46, 0x0E, 0xCD, 0xC2, 0x7C, 0x9D, 0x03, 0x42,
    0xC1, 0x8D, 0xC8, 0xBA, 0x63, 0xF2, 0x75, 0xE2, 0xB7, 0xF3, 0xEA, 0x8C,
    0x60, 0x8D, 0x95, 0x69, 0x89, 0xCA, 0x01, 0xF9, 0x6F, 0xFB, 0xD0, 0x53,
    0x56, 0x5B, 0x66, 0xAF, 0x02, 0x03, 0x01, 0x00, 0x01, 0x02, 0x82, 0x01,
    0x00, 0x11, 0xCE, 0xB3, 0xA3, 0xCE, 0xCA, 0x92, 0x69, 0x59, 0x4A, 0x29,
    0xF2, 0xEE, 0x7A, 0x1F, 0x75, 0xC5, 0xAF, 0x38, 0xC4, 0x7E, 0x1A, 0x9E,
    0xE0, 0x76, 0x69, 0x5D, 0x7A, 0x17, 0xBE, 0x3F, 0x28, 0xD2, 0x97, 0x26,
    0x1F, 0x8A, 0x3D, 0x24, 0xBF, 0xAD, 0xAB, 0x85, 0xCA, 0x0E, 0x34, 0xE1,
    0x8C, 0xB7, 0xF8, 0xC1, 0x50, 0xED, 0x5E, 0xDA, 0x67, 0x6E, 0x4F, 0xCB,
    0x79, 0x66, 0xD5, 0x0A, 0x13, 0xB7, 0x69, 0x4D, 0x72, 0xA1, 0xF6, 0x57,
    0x3F, 0x19, 0xE8, 0x2D, 0x98, 0x64, 0xD4, 0x2C, 0x77, 0x5B, 0x65, 0xAE,
    0x84, 0x36, 0xE8, 0xD1, 0xC7, 0x4C, 0x3A, 0x8F, 0x8E, 0xEE, 0xAE, 0xE3,
    0xF2, 0xF4, 0x2A, 0xE9, 0x96, 0x9B, 0xE0, 0x0E, 0xA4, 0xF6, 0x3B, 0x90,
    0xC4, 0xB7, 0x43, 0x2F, 0x1B, 0x3D, 0xE2, 0x7C, 0xFA, 0xDC, 0x6C, 0xC6,
    0x6E, 0xF4, 0xD5, 0x2E, 0x82, 0x11, 0x7A, 0xA2, 0x30, 0xBD, 0xE9, 0x02,
    0xC2, 0xBB, 0xEB, 0xFF, 0x79, 0xF2, 0xC8, 0xA7, 0xFA, 0x23, 0xC3, 0x9A,
    0xA7, 0x01, 0xC8, 0x0E, 0x4E, 0x4C, 0x0E, 0x83, 0x92, 0xD2, 0xDF, 0xE4,
    0x06, 0x6B, 0xF6, 0x62, 0x53, 0xCB, 0xAD, 0xDC, 0x97, 0xD8, 0x26, 0x26,
    0x4F, 0xBB, 0x9F, 0x40, 0x04, 0x74, 0x2A, 0xE0, 0x28, 0x67, 0x9C, 0x1D,
    0xFA, 0x31, 0x99, 0xE1, 0x8D, 0x2D, 0xE5, 0xA6, 0x8A, 0x58, 0x00, 0x81,
    0xE5, 0x49, 0xDD, 0x47, 0xB9, 0xD6, 0xCB, 0x5D, 0xFF, 0x53, 0xEF, 0xED,
    0xA0, 0x77, 0xF5, 0xD5, 0x61, 0x5E, 0xD2, 0xF5, 0x0B, 0xB7, 0x67, 0xAE,
    0x17, 0x8B, 0xF7, 0x5A, 0x35, 0xA2, 0xA7, 0x42, 0xF6, 0x36, 0x28, 0x80,
    0xEF, 0x70, 0x07, 0x97, 0xE1, 0xB5, 0xA7, 0xD9, 0xF7, 0xEC, 0xBD, 0x74,
    0xD3, 0xBB, 0x16, 0x72, 0xE0, 0x55, 0xB5, 0x9B, 0x1D, 0x4C, 0xCF, 0xE8,
    0x03, 0x4C, 0x98, 0xCB, 0xA1, 0x02, 0x81, 0x81, 0x00, 0xD2, 0x05, 0xF3,
    0x87, 0x63, 0x84, 0x61, 0x61, 0x85, 0x1B, 0x9D, 0x2F, 0x1E, 0xDF, 0x39,
    0x20, 0xE5, 0xF9, 0x1D, 0xC4, 0xA9, 0x17, 0x07, 0x2D, 0x98, 0x69, 0x5C,
    0xEA, 0x50, 0xDE, 0x19, 0x1D, 0xD7, 0x92, 0xF7, 0x7E, 0x00, 0x37, 0x2B,
    0x15, 0xA1, 0xD5, 0x1D, 0xE3, 0x89, 0x84, 0xB7, 0x8D, 0x56, 0x6D, 0x16,
    0x31, 0xCD, 0xBD, 0xEA, 0x37, 0x71, 0x33, 0xFD, 0x04, 0xA0, 0xA3, 0xB4,
    0x1E, 0x64, 0xD7, 0x75, 0xED, 0x5D, 0x27, 0xAB, 0x81, 0x94, 0x48, 0x1D,
    0x5C, 0x82, 0xD4, 0xC1, 0x4B, 0x4B, 0x59, 0x06, 0x7F, 0xBF, 0xEC, 0xCA,
    0xB1, 0x4F, 0x59, 0xDD, 0x60, 0xC6, 0x42, 0x77, 0x2D, 0xDE, 0x77, 0x19,
    0xA6, 0x23, 0xBC, 0x3B, 0x38, 0x22, 0x35, 0x45, 0x31, 0x0E, 0x71, 0xB4,
    0x8E, 0x9A, 0x7B, 0xF8, 0xCE, 0x79, 0xA1, 0x73, 0x31, 0x00, 0x31, 0x38,
    0x0B, 0xF0, 0xCC, 0x66, 0xE9, 0x02, 0x81, 0x81, 0x00, 0xC2, 0xD0, 0x32,
    0x79, 0x4D, 0x98, 0xB2, 0x3D, 0x7E, 0x55, 0x2C, 0x52, 0x62, 0x8E, 0x48,
    0xCC, 0xCD, 0xF5, 0x48, 0x95, 0xF0, 0x61, 0x12, 0x3A, 0xBF, 0x43, 0x9A,
    0xA6, 0xBA, 0x7D, 0xC0, 0xE7, 0xB6, 0xDB, 0x37, 0xB4, 0x5E, 0x3B, 0x24,
    0x83, 0xF5, 0xEC, 0x4B, 0xE9, 0xA9, 0x55, 0x48, 0x8E, 0x26, 0x53, 0x4C,
    0x6F, 0xAD, 0x3A, 0xCD, 0xA0, 0x76, 0x94, 0x65, 0xDE, 0x82, 0x68, 0x4D,
    0x7A, 0x52, 0x04, 0x05, 0xA3, 0x06, 0x49, 0x19, 0x16, 0x6E, 0xF8, 0xAB,
    0x60, 0xDD, 0x65, 0x94, 0xAF, 0x8D, 0xA1, 0x8C, 0x76, 0x72, 0xD3, 0x78,
    0xB3, 0xD9, 0x07, 0x6B, 0xFB, 0x5E, 0x1C, 0x37, 0x41, 0xA1, 0x11, 0x66,
    0x5A, 0x76, 0x2A, 0x77, 0x18, 0x77, 0x1D, 0x31, 0xD2, 0xDF, 0x85, 0x61,
    0xA2, 0x10, 0x09, 0x68, 0xC2, 0xDE, 0x96, 0x55, 0x53, 0x21, 0xD9, 0x26,
    0x81, 0x6E, 0xCF, 0x91, 0xD7, 0x02, 0x81, 0x80, 0x27, 0xF2, 0xFD, 0xD9,
    0xB8, 0xF2, 0x4B, 0x5B, 0xB3, 0x68, 0x07, 0x44, 0x19, 0x49, 0x38, 0xA2,
    0xAB, 0x5B, 0xF1, 0x6F, 0xA1, 0x02, 0x42, 0x59, 0x47, 0xEE, 0x72, 0xC0,
    0x17, 0x55, 0xC7, 0xCD, 0x47, 0x5E, 0x2B, 0x39, 0x8A, 0x6C, 0xF4, 0x03,
    0x0F, 0x5F, 0x6C, 0x6A, 0x05, 0x94, 0x7B, 0x1D, 0xA5, 0x5C, 0xE6, 0xA5,
    0xDE, 0x8E, 0xCB, 0x68, 0x74, 0x5E, 0x01, 0x38, 0xCA, 0x1D, 0x99, 0x7B,
    0x56, 0x8F, 0x2D, 0x5D, 0x53, 0x24, 0xE2, 0x98, 0xA9, 0x4D, 0xF6, 0x57,
    0xCC, 0x83, 0x0F, 0xA9, 0x74, 0xD1, 0xA0, 0x4C, 0xD8, 0x83, 0x00, 0x23,
    0x2E, 0x06, 0xD7, 0xF7, 0x3A, 0x7F, 0x16, 0x10, 0x61, 0x8A, 0xA2, 0x14,
    0x5A, 0x23, 0xC9, 0xD7, 0xE9, 0x99, 0xDC, 0x69, 0x72, 0x67, 0xEA, 0x82,
    0x5D, 0x9C, 0x4B, 0x3D, 0x6B, 0x21, 0x6C, 0xB9, 0xDB, 0x61, 0x81, 0x59,
    0xB4, 0x1A, 0x0D, 0x51, 0x02, 0x81, 0x80, 0x20, 0x78, 0xEB, 0xB0, 0xE4,
    0x8A, 0x4B, 0x4B, 0x8C, 0xBF, 0x4D, 0xBF, 0xFD, 0xC5, 0x91, 0xC4, 0xF1,
    0x9F, 0xAD, 0x15, 0xB1, 0x17, 0xBD, 0x1E, 0x25, 0xBB, 0x73, 0x0F, 0xCF,
    0x8E, 0x1E, 0x95, 0x81, 0x19, 0x51, 0x53, 0xB3, 0x51, 0x50, 0x68, 0xDE,
    0x99, 0x20, 0x9E, 0x36, 0x27, 0x8D, 0x0C, 0x84, 0xBE, 0xE5, 0xC2, 0xC7,
    0xB1, 0x41, 0x8D, 0x39, 0xB6, 0xCA, 0xB4, 0x28, 0x30, 0x92, 0x99, 0x8D,
    0x0A, 0x36, 0x96, 0x51, 0xF9, 0xE5, 0x40, 0xA4, 0x06, 0xB7, 0x2A, 0x52,
    0x3D, 0x18, 0x67, 0x9A, 0xC8, 0x0E, 0xCD, 0xBF, 0x9E, 0x18, 0x44, 0x82,
    0x2C, 0x86, 0x87, 0x43, 0xCC, 0x98, 0x39, 0x4C, 0x4B, 0xC6, 0x2F, 0xD5,
    0xFA, 0x86, 0x17, 0x81, 0xE3, 0x4F, 0xE6, 0xC2, 0x73, 0x4D, 0x2E, 0xE2,
    0x55, 0x6F, 0x2C, 0xEC, 0x45, 0x4A, 0xBB, 0xAC, 0xAC, 0xB1, 0x8A, 0x69,
    0x9A, 0x17, 0xC9, 0x02, 0x81, 0x80, 0x5B, 0xF4, 0x4E, 0x31, 0xE2, 0x50,
    0x62, 0xD4, 0xB0, 0x3C, 0xA8, 0x72, 0x52, 0x1F, 0xE8, 0x2E, 0x76, 0x34,
    0x50, 0x38, 0x44, 0xB5, 0xD2, 0x68, 0x04, 0xC9, 0xEA, 0x0A, 0x72, 0x70,
    0x59, 0xD1, 0x6F, 0x79, 0x33, 0xC0, 0x69, 0x65, 0xCF, 0xF6, 0xE8, 0xF9,
    0xF0, 0xE7, 0x7F, 0x13, 0x33, 0xA6, 0xDA, 0x86, 0x12, 0x82, 0x5B, 0x15,
    0x22, 0x27, 0xD5, 0xB4, 0x69, 0xF9, 0x7E, 0x08, 0xAE, 0x21, 0x0F, 0x56,
    0xDF, 0xE3, 0x1B, 0xBB, 0x7C, 0xA1, 0xAE, 0x9F, 0xBF, 0x79, 0xFA, 0x78,
    0x20, 0xF6, 0x6F, 0xE6, 0x98, 0x79, 0x74, 0xED, 0xF6, 0x46, 0x4E, 0x42,
    0xD9, 0x0D, 0xBF, 0xAB, 0x31, 0xFD, 0x61, 0x8F, 0x23, 0xBD, 0x15, 0x2D,
    0xD9, 0xB5, 0xF2, 0x75, 0xCC, 0x7D, 0x53, 0x0E, 0x76, 0xEC, 0xE5, 0x8A,
    0x6A, 0x86, 0xF4, 0x62, 0xD3, 0x90, 0x03, 0x72, 0x27, 0x75, 0x15, 0xFA,
    0x55, 0x6F};
const UINT private_key_length = 1190;

/* Define some HTML data (web page) with an HTTPS header to serve to connecting
   clients. */
UCHAR html_data[] = {"HTTP/1.1 200 OK\r\n"
                     "Date: Tue, 19 May 2020 23:59:59 GMT\r\n"
                     "Content-Type: text/html\r\n"
                     "Content-Length: 200\r\n\r\n"
                     "<html>\r\n"
                     "<body>\r\n"
                     "<b>Hello NetX Secure User!</b>\r\n"
                     "This is a simple webpage\r\n"
                     "served up using NetX Secure!\r\n"
                     "</body>\r\n"
                     "</html>\r\n"};

/* Define main entry point.  */
int main()
{
    /* Enter the ThreadX kernel.  */
    tx_kernel_enter();
}

/* Define the application – initialize drivers and TCP/IP setup.  */
void tx_application_define(void *first_unused_memory)
{
    UINT status;

    /* Initialize the NetX system.  */
    nx_system_initialize();

    /* Create a packet pool. Check status for errors. */
    status = nx_packet_pool_create(&pool_0, "NetX Main Packet Pool", 1536,
                                   (ULONG *)(((int)packet_pool_area + 64) & ~63),
                                   NX_PACKET_POOL_SIZE);

    /* Create an IP instance for the specific target. Check status for errors. */
    status = nx_ip_create(&ip_0, "NetX IP Instance 0",
                          DEVICE_IP_ADDRESS,
                          0xFFFFFF00UL,
                          &pool_0, _nx_linux_network_driver,
                          (UCHAR *)ip_thread_stack,
                          sizeof(ip_thread_stack),
                          1);

    /* Enable ARP and supply ARP cache memory for IP Instance 0. Check status for
         errors. */
    status = nx_arp_enable(&ip_0, (void *)arp_space_area, sizeof(arp_space_area));

    /* Enable ICMP */
    status = nx_icmp_enable(&ip_0);

    /* Enable TCP traffic. Check status for errors. */
    status = nx_tcp_enable(&ip_0);

    status = nx_ip_fragment_enable(&ip_0);

    /* Initialize the NetX Secure TLS system.  */
    nx_secure_tls_initialize();

    /* Create the TLS server thread to start handling incoming requests. */
    tx_thread_create(&tls_server_thread, "TLS Server thread", server_thread_entry, 0,
                     tls_server_thread_stack, sizeof(tls_server_thread_stack),
                     16, 16, 4, TX_AUTO_START);
    return;
}

/* Thread to handle the TLS Server instance. */
void server_thread_entry(ULONG thread_input)
{
    UINT status;
    ULONG actual_status;
    NX_PACKET *send_packet;
    NX_PACKET *receive_packet;
    UCHAR receive_buffer[100];
    ULONG bytes;

    NX_PARAMETER_NOT_USED(thread_input);

    /* Ensure the IP instance has been initialized.  */
    status = nx_ip_status_check(&ip_0, NX_IP_INITIALIZE_DONE, &actual_status,
                                NX_IP_PERIODIC_RATE);
    printf("nx_ip_status_check : %d\n", status);
    printf("nx_ip_status_check : 0x%x\n", status);

    /* Create a TCP socket to use for our TLS session.  */
    status = nx_tcp_socket_create(&ip_0, &tcp_socket, "TLS Server Socket",
                                  NX_IP_NORMAL, NX_FRAGMENT_OKAY,
                                  NX_IP_TIME_TO_LIVE, 8192, NX_NULL, NX_NULL);
    printf("nx_tcp_socket_create : %d\n", status);
    printf("nx_tcp_socket_create : 0x%x\n", status);

    /* Create a TLS session for our socket.  */
    status = nx_secure_tls_session_create(&tls_session,
                                          &nx_crypto_tls_ciphers_ecc,
                                          tls_crypto_metadata,
                                          sizeof(tls_crypto_metadata));
    printf("nx_secure_tls_session_create : %d\n", status);
    printf("nx_secure_tls_session_create : 0x%x\n", status);

    status = nx_secure_tls_ecc_initialize(&tls_session,
                                          nx_crypto_ecc_supported_groups,
                                          nx_crypto_ecc_supported_groups_size,
                                          nx_crypto_ecc_curves);
    printf("nx_secure_tls_ecc_initialize : %d\n", status);
    printf("nx_secure_tls_ecc_initialize : 0x%x\n", status);

    /* Set the packet reassembly buffer for this TLS session. */
    status = nx_secure_tls_session_packet_buffer_set(&tls_session, tls_packet_buffer,
                                                     sizeof(tls_packet_buffer));
    printf("nx_secure_tls_session_packet_buffer_set : %d\n", status);
    printf("nx_secure_tls_session_packet_buffer_set : 0x%x\n", status);

    /* Initialize an X.509 certificate and private ECC key for our TLS Session. */
    nx_secure_x509_certificate_initialize(&certificate, certificate_data,
                                          certificate_length, NX_NULL, 0,
                                          private_key, private_key_length,
                                          NX_SECURE_X509_KEY_TYPE_RSA_PKCS1_DER);
    printf("nx_secure_x509_certificate_initialize : %d\n", status);
    printf("nx_secure_x509_certificate_initialize : 0x%x\n", status);

    /* Add the initialized certificate as a local identity certificate. */
    nx_secure_tls_local_certificate_add(&tls_session, &certificate);

    /* Setup this thread to listen on the TCP socket.
       Port 443 is standard for HTTPS. */
    status = nx_tcp_server_socket_listen(&ip_0, 443, &tcp_socket, 5, NX_NULL);
    printf("nx_tcp_server_socket_listen : %d\n", status);
    printf("nx_tcp_server_socket_listen : 0x%x\n", status);

    while (1)
    {
        /* Accept a client TCP socket connection.  */
        status = nx_tcp_server_socket_accept(&tcp_socket, NX_WAIT_FOREVER);
        printf("nx_tcp_server_socket_accept : %d\n", status);
        printf("nx_tcp_server_socket_accept : 0x%x\n", status);

        /* Start the TLS Session using the connected TCP socket. */
        status = nx_secure_tls_session_start(&tls_session, &tcp_socket,
                                             NX_WAIT_FOREVER);
        printf("nx_secure_tls_session_start : %d\n", status);
        printf("nx_secure_tls_session_start : 0x%x\n", status);

        /* Receive the HTTPS request. */
        status = nx_secure_tls_session_receive(&tls_session, &receive_packet,
                                               NX_WAIT_FOREVER);
        printf("nx_secure_tls_session_receive : %d\n", status);
        printf("nx_secure_tls_session_receive : 0x%x\n", status);

        if (status == NX_SUCCESS)
        {
            /* Extract the HTTP request information from the HTTPS request. */
            status = nx_packet_data_extract_offset(receive_packet, 0, receive_buffer,
                                                   100, &bytes);
            printf("nx_packet_data_extract_offset : %d\n", status);
            printf("nx_packet_data_extract_offset : 0x%x\n", status);

            /* Display the HTTP request data. */
            receive_buffer[bytes] = 0;
            printf("Received data: %s\n", receive_buffer);

            /* Release the packet when done with it */
            nx_packet_release(receive_packet);
        }

        /* Allocate a TLS packet to send HTML data back to client. */
        status = nx_secure_tls_packet_allocate(&tls_session, &pool_0, &send_packet,
                                               NX_WAIT_FOREVER);
        printf("nx_secure_tls_packet_allocate : %d\n", status);
        printf("nx_secure_tls_packet_allocate : 0x%x\n", status);

        /* Populate the packet with our HTTP response and HTML web page data. */
        nx_packet_data_append(send_packet, html_data, sizeof(html_data), &pool_0,
                              NX_WAIT_FOREVER);

        /* Send the HTTP response over the TLS Session, turning it into HTTPS. */
        status = nx_secure_tls_session_send(&tls_session, send_packet,
                                            NX_WAIT_FOREVER);
        printf("nx_secure_tls_session_send : %d\n", status);
        printf("nx_secure_tls_session_send : 0x%x\n", status);

        /* If the send fails, you must release the packet.  */
        if (status != NX_SUCCESS)
        {
            /* Release the packet since it was not sent.  */
            nx_packet_release(send_packet);
        }

        /* End the TLS session now that we have sent our HTTPS/HTML response. */
        status = nx_secure_tls_session_end(&tls_session, NX_WAIT_FOREVER);
        printf("nx_secure_tls_session_end : %d\n", status);
        printf("nx_secure_tls_session_end : 0x%x\n", status);

        /* Check for errors to make sure the session ended cleanly! */

        /* Disconnect the TCP socket so we can be ready for the next request. */
        status = nx_tcp_socket_disconnect(&tcp_socket, NX_WAIT_FOREVER);
        printf("nx_tcp_socket_disconnect : %d\n", status);
        printf("nx_tcp_socket_disconnect : 0x%x\n", status);

        /* Unaccept the server socket.  */
        status = nx_tcp_server_socket_unaccept(&tcp_socket);
        printf("nx_tcp_server_socket_unaccept : %d\n", status);
        printf("nx_tcp_server_socket_unaccept : 0x%x\n", status);

        /* Setup server socket for listening again.  */
        status = nx_tcp_server_socket_relisten(&ip_0, 443, &tcp_socket);
        printf("nx_tcp_server_socket_relisten : %d\n", status);
        printf("nx_tcp_server_socket_relisten : 0x%x\n", status);
    }
}
